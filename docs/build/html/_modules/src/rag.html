<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.0.2 and Furo 2024.08.06 -->
        <title>src.rag - TechPulse documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">TechPulse  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/techpulse.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">TechPulse  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#overview-of-pipelines">Overview of Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#cloning-the-repository">Cloning the Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#setting-up-the-conda-environment">Setting Up the Conda Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_arxiv_vectorstore.html">Pipeline 1 - Retrieve ArXiv Data and Build Vector Store for RAG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_finetuning_evaluation_pipeline.html">Pipeline 2 - Finetune Model for Keyword Extraction and Model Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sentiment_extraction_model_selection.html">Select Sentiment Extraction Model + Evaluate Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline_retrieve_reddit_post_sentiment_keywords.html">Pipeline 3 - Retrieve Recent Reddit Posts and Extract Sentiments and Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../techpulse_ui.html">TechPulse User Interface</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">Modules</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Modules</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../pipeline_model_finetuning_evaluation.html">pipeline_model_finetuning_evaluation module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../model_training.html">model_training module - Finetuning Bart and T5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../finetune_BERT.html">model_training module - Finetuning BERT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../evaluation.html">evaluation module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../retrieve_papers_with_link.html">retrieve_papers_with_link module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rag.html">rag module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../infer_pipeline.html">infer_pipeline module - Pipeline to Retrieve Reddit Posts and Extract Sentiments and Keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../scrape_reddit.html">scrape_reddit - Extract from Reddit Posts using PRAW API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sentiment_analysis.html">sentiment_analysis - Extract Sentimentd from Reddit Posts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../extract_reddit_keywords_with_bart.html">extract_reddit_keywords - Use Finetuned Model to Extract Tech Keywords from Reddit Posts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../streamlit_poc_with_gemma.html">streamlit_poc_with_gemma module</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for src.rag</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides a ArXiv Research Paper Retrieval System using a Retrieval-Augmented Generator (RAG) pipeline.</span>
<span class="sd">It allows users to search for research papers based on keywords and returns relevant results,</span>
<span class="sd">including paper titles, categories, updated dates, summaries, and links.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModel</span><span class="p">,</span> <span class="n">AutoTokenizer</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">chromadb</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">chromadb.errors</span> <span class="kn">import</span> <span class="n">InvalidCollectionException</span>
<span class="kn">import</span> <span class="nn">hydra</span>
<span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">DictConfig</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Global variables</span>
<span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">collection</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">persist_directory</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="initialize_data_and_model">
<a class="viewcode-back" href="../../rag.html#src.rag.initialize_data_and_model">[docs]</a>
<span class="k">def</span> <span class="nf">initialize_data_and_model</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the data and model for the RAG pipeline.</span>

<span class="sd">    This function initializes the following objects:</span>

<span class="sd">    - df: a Pandas DataFrame containing the input data</span>
<span class="sd">    - tokenizer: a Hugging Face tokenizer for the pre-trained LLM</span>
<span class="sd">    - model: a Hugging Face model for the pre-trained LLM</span>
<span class="sd">    - client: a Chroma vector store client with persistence</span>
<span class="sd">    - persist_directory: the directory where the vector store is persisted</span>

<span class="sd">    The function takes a Hydra config object as input and sets up the data and model based on the config.</span>

<span class="sd">    Returns:</span>
<span class="sd">        df, tokenizer, model, client: the initialized objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">df</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">persist_directory</span>

    <span class="c1"># Step 1: Load the CSV file</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>

    <span class="c1"># Create the &#39;combined&#39; column</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Summary&#39;</span><span class="p">]</span>

    <span class="c1"># Step 2: Load a pre-trained LLM model for embeddings</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Step 3: Initialize Chroma vector store with persistence</span>
    <span class="n">persist_directory</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">vector_store</span><span class="o">.</span><span class="n">persist_directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">persist_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">chromadb</span><span class="o">.</span><span class="n">PersistentClient</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">persist_directory</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized client with persist_directory: </span><span class="si">{</span><span class="n">persist_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">client</span></div>


<span class="c1"># Function to get embeddings</span>
<div class="viewcode-block" id="get_embeddings">
<a class="viewcode-back" href="../../rag.html#src.rag.get_embeddings">[docs]</a>
<span class="k">def</span> <span class="nf">get_embeddings</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the embeddings for the given texts.</span>

<span class="sd">    Args:</span>
<span class="sd">        texts (List[str]): the input texts to embed</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: the embeddings for the input texts, with shape (len(texts), embedding_dim)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># Function to embed and store documents</span>
<div class="viewcode-block" id="embed_and_store_documents">
<a class="viewcode-back" href="../../rag.html#src.rag.embed_and_store_documents">[docs]</a>
<span class="k">def</span> <span class="nf">embed_and_store_documents</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embed the combined texts (title + summary) and store them in a Chroma vector store.</span>

<span class="sd">    This function takes no arguments and returns nothing. It uses the following global variables:</span>

<span class="sd">    - df: a Pandas DataFrame containing the research papers</span>
<span class="sd">    - client: a Chroma vector store client with persistence</span>
<span class="sd">    - persist_directory: the directory where the vector store is persisted</span>

<span class="sd">    The function does the following:</span>

<span class="sd">    1. Creates a new collection in the Chroma vector store called &quot;research_papers&quot;.</span>
<span class="sd">    2. Embeds the combined texts (title + summary) in batches using the get_embeddings function.</span>
<span class="sd">    3. Stores the embeddings and metadata in the Chroma vector store.</span>
<span class="sd">    4. Prints a message to the console indicating that the vector store has been created and saved to disk.</span>

<span class="sd">    The embeddings are stored in the vector store with the following metadata:</span>

<span class="sd">    - Title: the title of the research paper</span>
<span class="sd">    - Summary: the summary of the research paper</span>
<span class="sd">    - Updated: the date the research paper was last updated</span>
<span class="sd">    - Category: the category of the research paper</span>
<span class="sd">    - Link: the link to the research paper</span>

<span class="sd">    The function uses a batch size of 8 documents to reduce memory usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">collection</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span><span class="s2">&quot;research_papers&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created new collection&quot;</span><span class="p">)</span>

    <span class="n">combined_texts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_texts</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing batches&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;doc&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_texts</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch_texts</span> <span class="o">=</span> <span class="n">combined_texts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">get_embeddings</span><span class="p">(</span><span class="n">batch_texts</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">embed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">embeddings</span><span class="p">):</span>
                <span class="n">global_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">idx</span>
                <span class="k">if</span> <span class="n">global_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                    <span class="n">collection</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;doc_</span><span class="si">{</span><span class="n">global_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                        <span class="n">documents</span><span class="o">=</span><span class="p">[</span><span class="n">batch_texts</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span>
                        <span class="n">embeddings</span><span class="o">=</span><span class="n">embed</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                        <span class="n">metadatas</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;Title&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">][</span><span class="n">global_idx</span><span class="p">],</span>
                            <span class="s2">&quot;Summary&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Summary&#39;</span><span class="p">][</span><span class="n">global_idx</span><span class="p">],</span>
                            <span class="s2">&quot;Updated&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Updated&#39;</span><span class="p">][</span><span class="n">global_idx</span><span class="p">]),</span>
                            <span class="s2">&quot;Category&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">][</span><span class="n">global_idx</span><span class="p">],</span>
                            <span class="s2">&quot;Link&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">][</span><span class="n">global_idx</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_texts</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vector store created and saved to disk&quot;</span><span class="p">)</span></div>


<span class="c1"># Function to load vector store</span>
<div class="viewcode-block" id="load_vector_store">
<a class="viewcode-back" href="../../rag.html#src.rag.load_vector_store">[docs]</a>
<span class="k">def</span> <span class="nf">load_vector_store</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the vector store from disk. If the vector store is empty, it will be recreated and populated with the documents in the DataFrame.</span>
<span class="sd">    </span>
<span class="sd">    This function assumes that the Chroma client is already initialized. If it is not, it will print an error message and return without doing anything.</span>
<span class="sd">    </span>
<span class="sd">    If an existing collection is found but is empty, it will be deleted and recreated with the documents in the DataFrame. If an error occurs while loading the vector store, it will print an error message and return without doing anything.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">client</span><span class="p">,</span> <span class="n">collection</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Client is not initialized. Please run initialize_data_and_model first.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s2">&quot;research_papers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vector store is empty. Re-creating and populating...&quot;</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">(</span><span class="s2">&quot;research_papers&quot;</span><span class="p">)</span>
            <span class="n">embed_and_store_documents</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded vector store from disk with </span><span class="si">{</span><span class="n">collection</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">InvalidCollectionException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No existing collection found. Creating a new one and embedding documents...&quot;</span><span class="p">)</span>
        <span class="n">embed_and_store_documents</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while loading the vector store: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="c1"># Vector search function</span>
<div class="viewcode-block" id="vector_search">
<a class="viewcode-back" href="../../rag.html#src.rag.vector_search">[docs]</a>
<span class="k">def</span> <span class="nf">vector_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a vector search for a given query in the vector store.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The query string to search for.</span>
<span class="sd">        top_n: The number of top results to return. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dictionaries containing the metadata associated with the top results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">get_embeddings</span><span class="p">([</span><span class="n">query</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">query_embeddings</span><span class="o">=</span><span class="n">query_embedding</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="n">n_results</span><span class="o">=</span><span class="n">top_n</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">flatten</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;metadatas&#39;</span><span class="p">])</span></div>


<span class="c1"># Flatten function</span>
<div class="viewcode-block" id="flatten">
<a class="viewcode-back" href="../../rag.html#src.rag.flatten">[docs]</a>
<span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flatten a list of lists into a single list.</span>

<span class="sd">    Args:</span>
<span class="sd">        results (List[List]): A list of lists to be flattened.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List: A single list containing all elements from the sublists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flat_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sublist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">flat_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flat_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flat_results</span></div>


<span class="c1"># Keyword search function</span>
<div class="viewcode-block" id="keyword_search">
<a class="viewcode-back" href="../../rag.html#src.rag.keyword_search">[docs]</a>
<span class="k">def</span> <span class="nf">keyword_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a keyword search for a given query in the dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The query string to search for.</span>
<span class="sd">        top_n: The number of top results to return. Defaults to 15.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dictionaries containing the metadata associated with the top results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keyword_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">keyword_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;Title&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">],</span>
                <span class="s2">&quot;Updated&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Updated&#39;</span><span class="p">]),</span>
                <span class="s2">&quot;Category&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">],</span>
                <span class="s2">&quot;Summary&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Summary&#39;</span><span class="p">],</span>
                <span class="s2">&quot;Link&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Link&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyword_results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">top_n</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">keyword_results</span></div>


<span class="c1"># Hybrid search function</span>
<div class="viewcode-block" id="hybrid_search">
<a class="viewcode-back" href="../../rag.html#src.rag.hybrid_search">[docs]</a>
<span class="k">def</span> <span class="nf">hybrid_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a hybrid search for a given query in both the vector store and the dataframe.</span>

<span class="sd">    This function combines the results of a vector search and a keyword search, and returns the top</span>
<span class="sd">    results from both. The results are deduplicated by title, and the top results are returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (str): The query string to search for.</span>
<span class="sd">        top_n (int, optional): The number of top results to return. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of dictionaries containing the metadata associated with the top results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vector_results</span> <span class="o">=</span> <span class="n">vector_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>
    <span class="n">keyword_results</span> <span class="o">=</span> <span class="n">keyword_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>

    <span class="n">combined_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_titles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">vector_results</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Title&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_titles</span><span class="p">:</span>
                <span class="n">combined_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">seen_titles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">keyword_results</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_titles</span><span class="p">:</span>
            <span class="n">combined_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">seen_titles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Title&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">combined_results</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span></div>


<span class="c1"># Function to truncate summary</span>
<div class="viewcode-block" id="truncate_summary">
<a class="viewcode-back" href="../../rag.html#src.rag.truncate_summary">[docs]</a>
<span class="k">def</span> <span class="nf">truncate_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">word_limit</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Truncate a given summary to a specified word limit.</span>

<span class="sd">    Args:</span>
<span class="sd">        summary (str): The summary string to truncate.</span>
<span class="sd">        word_limit (int, optional): The maximum number of words to allow in the summary. Defaults to 30.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The truncated summary, or the original summary if it was already shorter than the word limit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">word_limit</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[:</span><span class="n">word_limit</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span>
    <span class="k">return</span> <span class="n">summary</span></div>


<span class="c1"># Add this new function</span>
<div class="viewcode-block" id="check_vector_store_size">
<a class="viewcode-back" href="../../rag.html#src.rag.check_vector_store_size">[docs]</a>
<span class="k">def</span> <span class="nf">check_vector_store_size</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the number of items in the vector store matches the number of items in the DataFrame.</span>
<span class="sd">    If not, re-create the vector store and populate it with the items from the DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection_size</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">df_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of items in vector store: </span><span class="si">{</span><span class="n">collection_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of items in DataFrame: </span><span class="si">{</span><span class="n">df_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">collection_size</span> <span class="o">==</span> <span class="n">df_size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All items from the DataFrame are stored in the vector store.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">collection_size</span> <span class="o">&lt;</span> <span class="n">df_size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Only </span><span class="si">{</span><span class="n">collection_size</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">df_size</span><span class="si">}</span><span class="s2"> items are stored in the vector store.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Re-creating and populating the vector store...&quot;</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">(</span><span class="s2">&quot;research_papers&quot;</span><span class="p">)</span>
            <span class="n">embed_and_store_documents</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: The vector store contains more items than the DataFrame.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vector store is not loaded or created.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="setup_rag">
<a class="viewcode-back" href="../../rag.html#src.rag.setup_rag">[docs]</a>
<span class="k">def</span> <span class="nf">setup_rag</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the RAG pipeline by loading the DataFrame, initializing the model and tokenizer, and loading the vector store.</span>

<span class="sd">    Args:</span>
<span class="sd">        cfg (DictConfig): The Hydra configuration object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">df</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">persist_directory</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">client</span> <span class="o">=</span> <span class="n">initialize_data_and_model</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">load_vector_store</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to initialize client. Vector store not loaded.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../rag.html#src.rag.main">[docs]</a>
<span class="nd">@hydra</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;../conf&quot;</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main entry point of the script. This function sets up the RAG pipeline, loads the vector store, checks its size, and provides an example usage of the hybrid search function.</span>

<span class="sd">    The example usage prompts the user to enter a keyword to search, and then displays the top N results. The results include the title, category, updated date, summary, and link of each paper.</span>

<span class="sd">    If the vector store cannot be created or loaded, the function prints an error message and exits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setup_rag</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">df</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">persist_directory</span>

    <span class="c1"># Initialize data and model</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">client</span> <span class="o">=</span> <span class="n">initialize_data_and_model</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Failed to initialize client. Exiting.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Load the vector store (this will create it if it doesn&#39;t exist)</span>
    <span class="n">load_vector_store</span><span class="p">()</span>

    <span class="c1"># Check the size of the vector store</span>
    <span class="n">check_vector_store_size</span><span class="p">()</span>

    <span class="c1"># Example usage</span>
    <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">collection</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter a keyword to search: &quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">hybrid_search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">top_n</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="s1">&#39;No Title&#39;</span><span class="p">)</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Category&#39;</span><span class="p">,</span> <span class="s1">&#39;No Category&#39;</span><span class="p">)</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Updated&#39;</span><span class="p">,</span> <span class="s1">&#39;No Date&#39;</span><span class="p">)</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">truncate_summary</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Summary&#39;</span><span class="p">,</span> <span class="s1">&#39;No Summary&#39;</span><span class="p">),</span> <span class="n">word_limit</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">word_limit</span><span class="p">)</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Link&#39;</span><span class="p">,</span> <span class="s1">&#39;No Link&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated: </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary: </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Link: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to create or load the vector store. Please check the error messages above.&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, TechPulse Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>